---
- name: Download scripts
  get_url:
    url: "https://get.docker.com/"
    dest: "/tmp/get-docker.sh"
    mode: "0776"

- name: Install docker
  command: "/tmp/get-docker.sh"
  environment:
    CHANNEL: stable

- name: Start docker daemon
  service:
    name: docker
    state: started
    enabled: true

- name: Add user in docker group
  user:
    name: "{{ run_user }}"
    groups: docker
    append: true

- block:
    - name: Update userns-remap config
      shell: |
        cp /etc/docker/daemon.json /etc/docker/daemon.json.backup
        jq '. += { "userns-remap" : "default" }' < /etc/docker/daemon.json > /tmp/daemon.json
        mv /tmp/daemon.json /etc/docker/daemon.json
  rescue:
    - name: Create /etc/docker/daemon.json and configure userns-remap
      blockinfile:
        path: /etc/docker/daemon.json
        marker: ""
        create: yes
        block: |
          {
            "userns-remap": "default"
          }
  when: enable_userns_remap|bool == true

- name: Enable docker swarm mode
  docker_swarm:
    state: present
    advertise_addr: "{{ swarm_advertise_addr }}"
  register: output
  when: enable_docker_swarm_mode|bool == true
